<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
    <link rel="icon" type="image/png" href="../assets/img/favicon.png">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>
        ASP.NET Core API Unit Tests
    </title>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
    
    <!--     Fonts and icons     -->
    <link rel="stylesheet" 
        type="text/css" 
        href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
    
    <link rel="stylesheet" 
        href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" 
        integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" 
        crossorigin="anonymous">

    <!-- Code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs2015.min.css">

    <!-- CSS Files -->
    <link href="../assets/css/material-kit.css?v=2.0.5" rel="stylesheet" />
    <link href="../assets/css/main.css" rel="stylesheet" />
</head>
<body class="profile-page sidebar-collapse">
        <nav class="navbar navbar-transparent navbar-color-on-scroll fixed-top navbar-expand-lg" color-on-scroll="100" id="sectionsNav">
        <div class="container">
            <div class="navbar-translate">
                <a class="navbar-brand" href="/">
                    I'm Johan
                </a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="navbar-toggler-icon"></span>
                    <span class="navbar-toggler-icon"></span>
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ml-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="/posts/index.html">
                                <i class="fa fa-blog"></i>
                                Blog
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/about">
                                <i class="fa fa-user"></i>
                                About Me
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/kudos">
                                <i class="fa fa-gift"></i>
                                Kudos
                            </a>
                        </li>
                <li class="nav-item">
                    <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="https://github.com/johanvergeer" target="_blank" data-original-title="Follow me on GitHub">
                        <i class="fab fa-github fa-2x"></i>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="https://www.linkedin.com/in/johanvergeer" target="_blank" data-original-title="Join my network on">
                        <i class="fab fa-linkedin fa-2x"></i>
                    </a>
                </li>
            </ul>
        </div>
        </div>
    </nav>

    <div class="page-header header-filter" 
    style='background-image: url("../assets/img/city-profile.jpg"); transform: translate3d(0px, 0px, 0px);' 
    data-parallax="true">
</div>

<div class="main main-raised">
    <div class="section section-basic">
        <div class="container">
                  


<div class="title">
    <h1>ASP.NET Core API Unit Tests</h1>
</div>

<div class="row mb-1">
    <div class="col">
        

<span class="mr-3"><i class="fa fa-user"></i> Johan Vergeer</span>
<span><i class="fa fa-calendar"></i> <time datetime="YYYY-05-DD">Sunday, May 19, 2019</time></span>
    </div>    
</div>
<div class="row mb-1">
    <div class="col">
        

<i class="fas fa-tags"></i> 



<a href="/tags/Csharp" class="badge badge-pill badge-lg badge-primary">
    Csharp
</a>


<a href="/tags/ASPNET-Core" class="badge badge-pill badge-lg badge-primary">
    ASP.NET Core
</a>


<a href="/tags/Unit-tests" class="badge badge-pill badge-lg badge-primary">
    Unit tests
</a>
    </div>   
</div>
<div class="row">
    <div class="col">
        <a href="/posts">Back To posts <i class="fas fa-chevron-right"></i><i class="fas fa-chevron-right"></i></a>
    </div>
</div>

<hr>

<p>ASP.NET Core API Controllers are just classes, which means they can be unit tested.</p>
<p>This can be explained best with an example.</p>
<h3 id="person-model">Person Model</h3>
<p>We'll start off with a <code>Person</code>  model.</p>
<script src="//gist.github.com/300a7aebba5bfd1b62f4fb2f468533ca.js" type="text/javascript"></script>
<p>This model has a <code>Name</code> and an <code>Age</code> property. It also has an <code>IsValid</code> property, returning whether the model is in a valid state.
This last property will be used later when we will work on the <code>Post</code> request.</p>
<h3 id="ipersonrepository">IPersonRepository</h3>
<p>I have only created the repository interface because an implementation is not required for these tests.
The methods are self-explanatory so I won't go into any detail here.</p>
<script src="//gist.github.com/89cb91b85a273bd5a472900f56988edf.js" type="text/javascript"></script>
<h3 id="personcontroller">PersonController</h3>
<p>The <code>PersonController</code> serves as the API endpoint.
The <code>Get()</code> method returns all people from the repository, and the <code>Post()</code> method allows a new <code>Person</code> to be added to the repository. Note a <code>BadRequest</code> is returned when the <code>IsValid</code> property on the <code>Person</code> model is <code>false</code>. Also note the <code>IPersonRepository</code> interface is passed in to the constructor. I'll get back on this later when we'll look at the tests.</p>
<script src="//gist.github.com/b515c0ff18a6bd695080f0c01190508d.js" type="text/javascript"></script>
<h2 id="tests">Tests</h2>
<div class='box box-note'>
<p>I'm using <a href="https://xunit.net/">xUnit.Net</a>, <a href="https://fluentassertions.com/">FluentAssertions</a> and <a href="https://github.com/Moq/moq4/wiki/Quickstart">Moq</a> for these tests.</p>
</div>
<p>Let's have a look at the tests. As I stated before, we're passing in the <code>IPersonRepository</code> interface to the constructor of <code>PersonController</code>. But we don't have an implementation for <code>IPersonRepository</code>. This is on purpose, sinse we want to test the controllers implementation, and not an implementation of <code>IPersonRepository</code>.</p>
<p>For this reason we'll use <a href="https://github.com/Moq/moq4/wiki/Quickstart">Moq</a>, which is an awesome library we will use to create a mock <code>IPersonRepository</code>. The following code snippet shows how mock the repository is instantiated.</p>
<script src="//gist.github.com/11795a249d1589e0bd43ba3119366e47.js" type="text/javascript"></script>
<h3 id="get-all-people-empty-list">Get all people - empty list</h3>
<p>For the first test we'll expect an empty list of <code>Person</code>. Before creating the <code>PersonController</code>, we have to setup the <code>Mock</code> object to return an empty <code>List&lt;Person&gt;</code> when <code>FindAll()</code> is called.</p>
<div class='box box-warning'>
<p>If we don't setup the mock, it will return null and throw an <code>ArgumentNullException</code> when <code>ToList()</code> is called in the controller.</p>
</div>
<p>After the controllers <code>Get()</code> method is called we assert the expected return type and whether the returned list is really empty.</p>
<script src="//gist.github.com/ccafc0ad059dea8e01ff419eb69de555.js" type="text/javascript"></script>
<h3 id="get-all-people-people-are-returned">Get all people - people are returned</h3>
<p>The next test we'll expect three <code>Person</code> objects. The <code>people</code> object we created is used in the <code>Returns()</code> method of the repository setup. This tells Moq to return the people whenever the <code>FindAll()</code> method is called on <code>IPersonRepository</code>.</p>
<p>After the controllers <code>Get()</code> method is called we assert the expected return type again, but this time we expect three <code>Person</code> objects, which should be equivalent to the <code>people</code> object we passed into the <code>Returns()</code> method of the repository setup.</p>
<p>Now that this works, let's see how we can add a <code>Person</code>.</p>
<script src="//gist.github.com/3fda5518c8b97c6fa1c1045df5f22b8b.js" type="text/javascript"></script>
<h3 id="post-a-person-person-has-valid-state">Post a person - Person has valid state</h3>
<p>After retrieving people from the API, it would also be nice if we can add people. That will be tested next.</p>
<p>In this first test, which is a happy flow, the <code>Person</code> object will be added. Since the <code>Add()</code> method on <code>IPersonRepository</code> doesn't return anything, we don't have to do a setup. So we just <code>Post</code> a <code>Peron</code> object, after which we assert whether we response is an <code>OkObjectResult</code> and has a valid message. One thing we <strong>do</strong> want to verify here though, is whether the <code>Add()</code> method was called on <code>IPersonRepository</code> once and only once.</p>
<script src="//gist.github.com/1602b7cca1ab50b45480f1ffd0f64e98.js" type="text/javascript"></script>
<h3 id="post-a-person-person-has-invalid-state">Post a person - Person has invalid state</h3>
<p>In this last test, we have to see what happens if the <code>Person</code> doesn't have a valid state, which we'll test by not setting the <code>Name</code> property. In this case we assert whether the returned result is a <code>BadRequestObjectResult</code> and has a valid message. A more important assertion to note here is that we verify the <code>Add()</code> method on <code>IPersonRepository</code> is <strong>Never</strong> called.</p>
<script src="//gist.github.com/a0d88a8857827cdc7d7ff9c23d698beb.js" type="text/javascript"></script>
<h2 id="conclusion">Conclusion</h2>
<p>As you can see, we can test an API controller without any integration to other components of the application. We didn't even need an implementation for the repository. This way we have a fast and loosely coupled way to test our controllers.</p>
<p>The code for this project is located in the <a href="https://github.com/johanvergeer/ImJohan.Blog.AspNetCoreApiUnitTests">GitHub repo</a>.</p>


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'johanvergeer-github-io'; // required: replace example with your forum shortname
    var disqus_identifier = 'asp-net-core-api-unit-tests';
    var disqus_title = 'ASP.NET Core API Unit Tests';
    var disqus_url = 'http://johanvergeer.github.io/posts/asp-net-core-api-unit-tests';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
    </div>
</div>

    <footer class="footer footer-default">
    <div class="container">
      <nav class="float-left">
        <ul>
          <li>
            <a href="/">
              I'm Johan
            </a>
          </li>
        </ul>
      </nav>
      <div class="copyright float-right">
        ©
        <script>
          document.write(new Date().getFullYear())
        </script>, made with <i class="material-icons">favorite</i> by
        <a href="https://johanvergeer.github.io" target="_blank">Johan Vergeer</a>.
      </div>
    </div>
  </footer>
    <!--   Core JS Files   -->
<script src="../assets/js/core/jquery.min.js" type="text/javascript"></script>
<script src="../assets/js/core/popper.min.js" type="text/javascript"></script>
<script src="../assets/js/core/bootstrap-material-design.min.js" type="text/javascript"></script>
<script src="../assets/js/plugins/moment.min.js"></script>
<!--	Plugin for the Datepicker, full documentation here: https://github.com/Eonasdan/bootstrap-datetimepicker -->
<script src="../assets/js/plugins/bootstrap-datetimepicker.js" type="text/javascript"></script>
<!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
<script src="../assets/js/plugins/nouislider.min.js" type="text/javascript"></script>
<!-- Control Center for Material Kit: parallax effects, scripts for the example pages etc -->
<script src="../assets/js/material-kit.js?v=2.0.5" type="text/javascript"></script>

<!-- Code highlighting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/cs.min.js"></script>
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/css.min.js"></script>
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/json.min.js"></script>
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/markdown.min.js"></script>
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/powershell.min.js"></script>
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>